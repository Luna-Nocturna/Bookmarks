<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Menu Editor</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .tree ul { list-style-type: none; padding-left: 20px; }
    .tree li { margin: 5px 0; }
    .tree button { margin-left: 5px; }
    input { margin-left: 5px; }
    .link-input { width: 250px; }
  </style>
</head>
<body>
  <h1>Menu Editor</h1>
  <div class="tree" id="menu-tree"></div>
  <button onclick="saveTree()">Save to GitHub</button>

  <script>
    const owner = "Luna-Nocturna";
    const repo = "Bookmarks";
    const path = "menu.html";
    const token = "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"; // keep private
    let currentSha = ""

    let menuData = []; // tree structure

    // ---------------------- Load ----------------------
    async function loadMenu() {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
      const data = await res.json();
      currentSha = data.sha;
      const html = atob(data.content);
      menuData = parseHTML(html);
      renderTree();
    }

    // ---------------------- Parse HTML into tree ----------------------
    function parseHTML(html) {
      const container = document.createElement('div');
      container.innerHTML = html;
      function parseUL(ul) {
        const items = [];
        Array.from(ul.children).forEach(li => {
          const a = li.querySelector('a');
          const span = a.querySelector('span.menu-text');
          const text = span ? span.textContent : a.textContent;
          const href = a.getAttribute('href');
          const subUL = li.querySelector('ul');
          items.push({
            text,
            href,
            children: subUL ? parseUL(subUL) : []
          });
        });
        return items;
      }
      return parseUL(container.querySelector('ul') || container);
    }

    // ---------------------- Render tree ----------------------
    function renderTree() {
      const container = document.getElementById('menu-tree');
      container.innerHTML = '';
      function createNode(item, parentArray) {
        const li = document.createElement('li');

        const textInput = document.createElement('input');
        textInput.value = item.text;
        textInput.oninput = () => item.text = textInput.value;

        const hrefInput = document.createElement('input');
        hrefInput.value = item.href;
        hrefInput.placeholder = "URL";
        hrefInput.className = "link-input";
        hrefInput.oninput = () => item.href = hrefInput.value;

        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add Sub';
        addBtn.onclick = () => {
          const newItem = { text: 'New Item', href: '#', children: [] };
          item.children.push(newItem);
          renderTree();
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => {
          const index = parentArray.indexOf(item);
          parentArray.splice(index, 1);
          renderTree();
        };

        li.appendChild(textInput);
        li.appendChild(hrefInput);
        li.appendChild(addBtn);
        li.appendChild(delBtn);

        if (item.children && item.children.length > 0) {
          const ul = document.createElement('ul');
          item.children.forEach(child => ul.appendChild(createNode(child, item.children)));
          li.appendChild(ul);
        }
        return li;
      }

      const ulRoot = document.createElement('ul');
      menuData.forEach(item => ulRoot.appendChild(createNode(item, menuData)));
      container.appendChild(ulRoot);

      // Add button for new top-level category
      const addTopBtn = document.createElement('button');
      addTopBtn.textContent = 'Add Top Category';
      addTopBtn.onclick = () => {
        menuData.push({ text: 'New Category', href: '#', children: [] });
        renderTree();
      };
      container.appendChild(addTopBtn);
    }

    // ---------------------- Convert tree back to HTML ----------------------
    function treeToHTML(items) {
      if (!items || items.length === 0) return '';
      let html = '<ul>';
      items.forEach(item => {
        html += '<li>';
        html += `<a href="${item.href}"><span class="menu-text">${item.text}</span></a>`;
        html += treeToHTML(item.children);
        html += '</li>';
      });
      html += '</ul>';
      return html;
    }

    // ---------------------- Save to GitHub ----------------------
    async function saveTree() {
      const html = treeToHTML(menuData);
      const content = btoa(html);
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: "Update menu via editor",
          content: content,
          sha: currentSha
        })
      });
      const result = await res.json();
      if(result.content) {
        alert("Saved successfully!");
        currentSha = result.content.sha;
      } else {
        alert("Save failed. Check console.");
        console.log(result);
      }
    }

    loadMenu();
  </script>
</body>
</html>
