<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Menu Editor</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background-color: #121212;
      color: #e0e0e0;
      font-size: 16px;
    }

    button {
      border-radius: 6px;
      padding: 4px 8px;
      font-size: 16px;
      background-color: #333;
      color: #e0e0e0;
      border: 1px solid #555;
      cursor: pointer;
    }

    button:hover {
      background-color: #444;
    }

    .tree ul {
      list-style-type: none;
      padding-left: 20px;
      margin: 0;
    }

    .tree li {
      margin: 10px 0;
      /* keep normal vertical stacking */
    }

    .node-buttons-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .up-down-buttons {
      display: flex;
      flex-direction: row; /* side by side */
      gap: 4px;
    }

    .node-buttons {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .node-buttons input {
      border-radius: 6px;
      padding: 4px 6px;
      font-size: 16px;
      background-color: #1e1e1e;
      color: #e0e0e0;
      border: 1px solid #333;
    }

    .link-input {
      width: 750px; /* twice as long */
    }

    #add-top-btn {
      margin-bottom: 15px;
    }

  </style>
</head>
<body>
  <h1>Menu Editor</h1>
  <button id="add-top-btn" onclick="addTopCategory()">Add Top Category</button>
  <div class="tree" id="menu-tree"></div>
  <button onclick="saveTree()">Save Menu</button>

  <script>
    const owner = "Luna-Nocturna";
    const repo = "Bookmarks";
    const path = "menu.html";
    const token = "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"; // keep private
    let currentSha = ""
    let menuData = [];

    // ---------------------- Load ----------------------
    async function loadMenu() {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`);
      const data = await res.json();
      currentSha = data.sha;
      const html = atob(data.content);
      menuData = parseHTML(html);
      renderTree();
    }

    // ---------------------- Parse HTML ----------------------
    function parseHTML(html) {
      const container = document.createElement('div');
      container.innerHTML = html;

      function parseUL(ul) {
        const items = [];
        Array.from(ul.children).forEach(li => {
          if (li.tagName !== 'LI') return;
          const a = li.querySelector('a');
          const span = a ? a.querySelector('span.menu-text') : null;
          const text = span ? span.textContent : (a ? a.textContent : '');
          const href = a ? a.getAttribute('href') : '#';
          const subUL = li.querySelector('ul');
          items.push({
            text,
            href,
            children: subUL ? parseUL(subUL) : []
          });
        });
        return items;
      }

      const topItems = [];
      Array.from(container.children).forEach(node => {
        if (node.tagName === 'LI') {
          topItems.push({
            text: node.querySelector('span.menu-text')?.textContent || '',
            href: node.querySelector('a')?.getAttribute('href') || '#',
            children: node.querySelector('ul') ? parseUL(node.querySelector('ul')) : []
          });
        } else if (node.tagName === 'UL') {
          parseUL(node).forEach(i => topItems.push(i));
        }
      });
      return topItems;
    }

    // ---------------------- Render Tree ----------------------
    function renderTree() {
      const container = document.getElementById('menu-tree');
      container.innerHTML = '';

      function createNode(item, parentArray) {
        const li = document.createElement('li');

        // Up/Down + inputs wrapper
        const wrapperDiv = document.createElement('div');
        wrapperDiv.className = 'node-buttons-wrapper';

        // Up/Down buttons
        const upDownDiv = document.createElement('div');
        upDownDiv.className = 'up-down-buttons';

        const upBtn = document.createElement('button');
        upBtn.textContent = '↑';
        upBtn.onclick = () => {
          const index = parentArray.indexOf(item);
          if(index > 0){
            [parentArray[index-1], parentArray[index]] = [parentArray[index], parentArray[index-1]];
            renderTree();
          }
        };

        const downBtn = document.createElement('button');
        downBtn.textContent = '↓';
        downBtn.onclick = () => {
          const index = parentArray.indexOf(item);
          if (index < parentArray.length - 1) {
            [parentArray[index], parentArray[index + 1]] =
            [parentArray[index + 1], parentArray[index]];
            renderTree();
          }
        };


        upDownDiv.appendChild(upBtn);
        upDownDiv.appendChild(downBtn);

        // Node fields + action buttons
        const nodeDiv = document.createElement('div');
        nodeDiv.className = 'node-buttons';

        const textInput = document.createElement('input');
        textInput.value = item.text;
        textInput.oninput = () => item.text = textInput.value;

        const hrefInput = document.createElement('input');
        hrefInput.value = item.href;
        hrefInput.placeholder = "URL";
        hrefInput.className = "link-input";
        hrefInput.oninput = () => item.href = hrefInput.value;

        const addBtn = document.createElement('button');
        addBtn.textContent = 'Add Sub';
        addBtn.onclick = () => {
          const newItem = { text: 'New Item', href: '#', children: [] };
          item.children.push(newItem);
          renderTree();
        };

        const delBtn = document.createElement('button');
        delBtn.textContent = 'Delete';
        delBtn.onclick = () => {
          const index = parentArray.indexOf(item);
          parentArray.splice(index, 1);
          renderTree();
        };

        nodeDiv.appendChild(textInput);
        nodeDiv.appendChild(hrefInput);
        nodeDiv.appendChild(addBtn);
        nodeDiv.appendChild(delBtn);

        // combine wrapper
        wrapperDiv.appendChild(upDownDiv);
        wrapperDiv.appendChild(nodeDiv);
        li.appendChild(wrapperDiv);

        // Children recursively
        if(item.children && item.children.length > 0){
          const ul = document.createElement('ul');
          item.children.forEach(child => ul.appendChild(createNode(child, item.children)));
          li.appendChild(ul);
        }

        return li;
      }

      const ulRoot = document.createElement('ul');
      menuData.forEach(item => ulRoot.appendChild(createNode(item, menuData)));
      container.appendChild(ulRoot);
    }

    // ---------------------- Add Top Category ----------------------
    function addTopCategory() {
      menuData.push({ text: 'New Category', href: '#', children: [] });
      renderTree();
    }

    // ---------------------- Convert Tree to HTML ----------------------
function treeToHTML(items, indent = 0) {
  if (!items || items.length === 0) return '';
  let html = '';
  const spacer = '  '.repeat(indent); // 2 spaces per indent

  html += indent === 0 ? '' : spacer + '<ul>\n';
  items.forEach(item => {
    html += spacer + '  <li>';
    html += `<a href="${item.href}"><span class="menu-text">${item.text}</span></a>\n`;
    if (item.children && item.children.length > 0) {
      html += treeToHTML(item.children, indent + 2);
      html += spacer + '  ';
    }
    html += '</li>\n';
  });
  html += indent === 0 ? '' : spacer + '</ul>\n';
  return html;
}


    // ---------------------- Save to GitHub ----------------------
async function saveTree() {
  const html = treeToHTML(menuData);
  const content = btoa(html);
  const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: "Update menu via editor",
      content: content,
      sha: currentSha
    })
  });
  const result = await res.json();
  if(result.content) {
    alert("Menu saved successfully!");
    currentSha = result.content.sha;
    // Redirect to main page
    window.location.href = 'index.html';
  } else {
    alert("Save failed. Check console.");
    console.log(result);
  }
}


    loadMenu();
  </script>
</body>
</html>
